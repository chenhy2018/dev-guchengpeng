#!/bin/bash

confFile=$HOME/.qcheckout

function createConf {
	rm -f $confFile
	echo -e '\033[31mwe need some information about your qbox dev environment\033[0m'
	echo 'Generating qcheckout config...'
	read -p 'Enter path of your qbox root : ' qboxRoot
	while true; do
		read -p 'Enter your repository(one repository pre line, empty line for finish) : ' repository
		if [ -z "$repository" ]
		then
			break
		fi
		echo $qboxRoot"/"$repository >> $confFile
	done
}

function switchBranch {
	cd $1
        echo "// -----------------------------"
        echo "// Repo: $1"
	git checkout master
	git pull
	git checkout $2
}

function createBranch {
	cd $1
        echo "// -----------------------------"
        echo "// Repo: $1"
        git checkout master
	git pull
	git checkout -b $2
	git push origin $2
}
function showBranch {
	cd $1
	name=`echo $1 | sed -e 's,.*/\(.*\),\1,'`
	branch=`git branch | grep '*' | sed -e 's,.* \(.*\),\1,'`
	echo -n $name
	echo -e "\t["$branch"]"
}

function switchAll {
	while read line
	do switchBranch $line $1
	done < $confFile
}

function createAll {
	while read line
	do createBranch $line $1
	done < $confFile
}
function showAll {
        while read line
        do showBranch $line $1
        done < $confFile
	echo ""
}

function printHelp {
	echo 'usage:
qcheckout [options] branch_name
Options:
	-h		print this message
	-b		create new branch
	-r		reset config
        -s              list current branch
	'
}

create=false
reset=false
show=false
branch=""

args=`getopt brhs $*`
set -- $args
for i
do
	if [ "$i" = "-h" ]
	then
		printHelp
		exit 0
	fi
	if [ "$i" = "-b" ]
	then
		create=true
		continue
	fi
	if [ "$i" = "-r" ]
	then
		reset=true
		continue
	fi
	if [ "$i" = "-s" ]
        then
                show=true
                continue
        fi
	if [ "$i" != "--" ]
	then
		branch=$i
	fi
done

if [ ! -e "$confFile" ]
then
	reset=true
fi

if $reset
then
	createConf
	exit 0
fi

if $show
then
        showAll
        exit 0
fi

if [ -z "$branch" ]
then
	printHelp
	exit
fi

if $create
then
	createAll $branch
else
	switchAll $branch
fi

#createConf


